version: '3.9'

services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    ports:
      - '${DB_PORT:-5432}:5432'
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-streamflix}
      API_DB_PASSWORD: ${API_DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d

  backend:
    image: node:20
    working_dir: /usr/src/app
    depends_on:
      - postgres
    environment:
      NODE_ENV: development
      PORT: "5000"
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@postgres:5432/${DB_NAME:-streamflix}?schema=public
      API_DATABASE_URL: postgresql://api_user_account:${API_DB_PASSWORD}@postgres:5432/${DB_NAME:-streamflix}?schema=public
      JWT_SECRET: dev-super-secret
      JWT_REFRESH_SECRET: dev-super-refresh-secret
      FRONTEND_URL: http://localhost:5173
      REQUIRE_EMAIL_VERIFICATION: "true"
      MAIL_HOST: smtp.mailtrap.io
      MAIL_PORT: 2525
      MAIL_USER: dev-user
      MAIL_PASS: dev-pass
      MAIL_FROM: noreply@streamflix.com
      INTERNAL_API_KEY: internal-only-key
      TMDB_API_KEY: ${TMDB_API_KEY:-demo-key}
    command: sh -c "npm install && npx prisma generate && npx prisma migrate deploy && node prisma/seed.js && npm run dev"
    ports:
      - '5000:5000'
    volumes:
      - ./backend:/usr/src/app

  frontend:
    image: node:20
    working_dir: /usr/src/app
    depends_on:
      - backend
    environment:
      VITE_API_URL: http://127.0.0.1:5000/api
      VITE_INTERNAL_API_ENABLED: "false"
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
    ports:
      - '5173:5173'
    volumes:
      - ./frontend:/usr/src/app

volumes:
  pgdata:

